<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>民泊物件シミュレーター</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
<!-- Charts: CSS-based -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
body { margin: 0; }
#root { min-height: 100vh; }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel" data-type="module">
const { useState, useMemo, useEffect, useCallback } = React;
/* Simple CSS Bar Chart Component */
const SimpleBarChart = ({data}) => {
  const maxVal = Math.max(...data.flatMap(d=>[Math.abs(d["民泊新法"]),Math.abs(d["旅館業"])])) || 1;
  return React.createElement("div",{className:"space-y-2"},
    React.createElement("div",{className:"flex items-center gap-4 mb-2 text-xs text-gray-500"},
      React.createElement("span",{className:"flex items-center gap-1"},React.createElement("span",{className:"inline-block w-3 h-3 bg-blue-500 rounded-sm"}),"民泊新法"),
      React.createElement("span",{className:"flex items-center gap-1"},React.createElement("span",{className:"inline-block w-3 h-3 bg-emerald-500 rounded-sm"}),"旅館業")
    ),
    data.map((d,i) => React.createElement("div",{key:i,className:"flex items-center gap-2 text-xs"},
      React.createElement("span",{className:"w-10 text-right text-gray-400 shrink-0"},d.name),
      React.createElement("div",{className:"flex-1 flex flex-col gap-1"},
        React.createElement("div",{className:"h-4 flex items-center"},
          React.createElement("div",{
            className:"h-full rounded-sm " + (d["民泊新法"]>=0?"bg-blue-500":"bg-red-400"),
            style:{width: Math.max(Math.abs(d["民泊新法"])/maxVal*100,2)+"%",minWidth:"2px"},
            title: d["民泊新法"]+"万円"
          }),
          React.createElement("span",{className:"ml-1 text-gray-500",style:{fontSize:10}},d["民泊新法"]+"万")
        ),
        React.createElement("div",{className:"h-4 flex items-center"},
          React.createElement("div",{
            className:"h-full rounded-sm " + (d["旅館業"]>=0?"bg-emerald-500":"bg-red-400"),
            style:{width: Math.max(Math.abs(d["旅館業"])/maxVal*100,2)+"%",minWidth:"2px"},
            title: d["旅館業"]+"万円"
          }),
          React.createElement("span",{className:"ml-1 text-gray-500",style:{fontSize:10}},d["旅館業"]+"万")
        )
      )
    ))
  );
};

/* ===================================================================
   定数
   =================================================================== */
const LAYOUTS = ["ワンルーム","1K","1DK","1LDK","2K","2DK","2LDK","3K","3DK","3LDK","4LDK以上"];
const OCCUPANCY_RATES = [0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9];
const DAYS_IN_MONTH = [31,28,31,30,31,30,31,31,30,31,30,31];
const MONTH_LABELS = ['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'];
const MONTHLY_PRESETS = {
  uniform: {label:"均一(70%)", values:[70,70,70,70,70,70,70,70,70,70,70,70]},
  busy: {label:"繁忙期型", values:[55,55,75,80,80,65,65,65,75,70,75,60]},
  tourist: {label:"観光地型", values:[50,50,65,70,85,60,70,80,65,60,65,75]},
};

const ZONES = [
  { id:"daiichi_teiso",   label:"第一種低層住居専用地域",   ryokan:false, minpaku:true,  note:"" },
  { id:"daini_teiso",     label:"第二種低層住居専用地域",   ryokan:false, minpaku:true,  note:"" },
  { id:"daiichi_chukoso", label:"第一種中高層住居専用地域", ryokan:false, minpaku:true,  note:"" },
  { id:"daini_chukoso",   label:"第二種中高層住居専用地域", ryokan:true,  minpaku:true,  note:"旅館業: 3,000㎡以下のみ" },
  { id:"daiichi_jukyo",   label:"第一種住居地域",           ryokan:true,  minpaku:true,  note:"旅館業: 3,000㎡以下のみ" },
  { id:"daini_jukyo",     label:"第二種住居地域",           ryokan:true,  minpaku:true,  note:"" },
  { id:"jun_jukyo",       label:"準住居地域",               ryokan:true,  minpaku:true,  note:"" },
  { id:"kinrin_shogyo",   label:"近隣商業地域",             ryokan:true,  minpaku:true,  note:"" },
  { id:"shogyo",          label:"商業地域",                 ryokan:true,  minpaku:true,  note:"" },
  { id:"jun_kogyo",       label:"準工業地域",               ryokan:true,  minpaku:true,  note:"" },
  { id:"kogyo",           label:"工業地域",                 ryokan:false, minpaku:true,  note:"" },
  { id:"kogyo_senyo",     label:"工業専用地域",             ryokan:false, minpaku:false, note:"民泊新法・旅館業ともに不可" },
  { id:"unknown",         label:"不明・未確認",             ryokan:null,  minpaku:null,  note:"用途地域を確認してください" },
];

const MUNICIPALITIES = [
  { id:"none",        pref:"",       label:"（選択してください）",    minpakuDays:180, restriction:"",                                                                            tokku:false },
  { id:"shinjuku",    pref:"東京都", label:"東京都 新宿区",          minpakuDays:180, restriction:"住居専用地域では月曜正午〜金曜正午は営業不可（実質 週末のみ約104日）",          residentialDays:104, tokku:false },
  { id:"shibuya",     pref:"東京都", label:"東京都 渋谷区",          minpakuDays:180, restriction:"住居専用地域では月曜正午〜金曜正午は営業不可",                                  residentialDays:104, tokku:false },
  { id:"minato",      pref:"東京都", label:"東京都 港区",            minpakuDays:180, restriction:"特段の上乗せ規制なし",                                                          tokku:false },
  { id:"ota",         pref:"東京都", label:"東京都 大田区",          minpakuDays:180, restriction:"国家戦略特区（特区民泊）あり。特区民泊は6泊7日以上のみ",                        tokku:true, tokkuNote:"特区民泊: 年間日数制限なし（365日可能）。ただし1回の宿泊が6泊7日以上必要" },
  { id:"taito",       pref:"東京都", label:"東京都 台東区",          minpakuDays:180, restriction:"住居専用地域では制限あり",                                                      residentialDays:104, tokku:false },
  { id:"chiyoda",     pref:"東京都", label:"東京都 千代田区",        minpakuDays:180, restriction:"住居専用地域で平日制限あり",                                                    residentialDays:104, tokku:false },
  { id:"toshima",     pref:"東京都", label:"東京都 豊島区",          minpakuDays:180, restriction:"特段の上乗せ規制なし",                                                          tokku:false },
  { id:"sumida",      pref:"東京都", label:"東京都 墨田区",          minpakuDays:180, restriction:"比較的緩和",                                                                    tokku:false },
  { id:"osaka_city",  pref:"大阪府", label:"大阪府 大阪市",          minpakuDays:180, restriction:"国家戦略特区（特区民泊）あり。比較的緩和的",                                    tokku:true, tokkuNote:"特区民泊: 年間日数制限なし（365日可能）。最低2泊3日以上" },
  { id:"kyoto_city",  pref:"京都府", label:"京都府 京都市",          minpakuDays:60,  restriction:"住居専用地域では1月15日〜3月15日のみ営業可（約60日）。その他地域も独自制限あり",  residentialDays:60, tokku:false },
  { id:"sapporo",     pref:"北海道", label:"北海道 札幌市",          minpakuDays:180, restriction:"住居専用地域で一部制限あり",                                                    residentialDays:130, tokku:false },
  { id:"fukuoka_city",pref:"福岡県", label:"福岡県 福岡市",          minpakuDays:180, restriction:"比較的緩和",                                                                    tokku:false },
  { id:"naha",        pref:"沖縄県", label:"沖縄県 那覇市",          minpakuDays:180, restriction:"比較的緩和",                                                                    tokku:false },
  { id:"other",       pref:"",       label:"その他（規制なし想定）",  minpakuDays:180, restriction:"お住まいの自治体に確認してください",                                            tokku:false },
];

const ADDRESS_PATTERNS = [
  { pattern:"新宿区", muniId:"shinjuku" }, { pattern:"渋谷区", muniId:"shibuya" },
  { pattern:"港区",   muniId:"minato" },   { pattern:"大田区", muniId:"ota" },
  { pattern:"台東区", muniId:"taito" },    { pattern:"千代田区", muniId:"chiyoda" },
  { pattern:"豊島区", muniId:"toshima" },  { pattern:"墨田区", muniId:"sumida" },
  { pattern:"大阪市", muniId:"osaka_city" },{ pattern:"京都市", muniId:"kyoto_city" },
  { pattern:"札幌市", muniId:"sapporo" },  { pattern:"福岡市", muniId:"fukuoka_city" },
  { pattern:"那覇市", muniId:"naha" },
];

const ZONING_KEYWORDS = [
  { pattern:"歌舞伎町", zone:"shogyo" },{ pattern:"銀座",   zone:"shogyo" },
  { pattern:"六本木",   zone:"shogyo" },{ pattern:"赤坂",   zone:"kinrin_shogyo" },
  { pattern:"表参道",   zone:"shogyo" },{ pattern:"原宿",   zone:"kinrin_shogyo" },
  { pattern:"池袋",     zone:"shogyo" },{ pattern:"秋葉原", zone:"shogyo" },
  { pattern:"浅草",     zone:"shogyo" },{ pattern:"上野",   zone:"shogyo" },
  { pattern:"日本橋",   zone:"shogyo" },{ pattern:"丸の内", zone:"shogyo" },
  { pattern:"新橋",     zone:"shogyo" },{ pattern:"品川",   zone:"kinrin_shogyo" },
  { pattern:"難波",     zone:"shogyo" },{ pattern:"なんば", zone:"shogyo" },
  { pattern:"心斎橋",   zone:"shogyo" },{ pattern:"梅田",   zone:"shogyo" },
  { pattern:"天神",     zone:"shogyo" },{ pattern:"博多",   zone:"shogyo" },
  { pattern:"国際通り", zone:"shogyo" },{ pattern:"祇園",   zone:"kinrin_shogyo" },
  { pattern:"河原町",   zone:"shogyo" },{ pattern:"すすきの",zone:"shogyo" },
  { pattern:"住宅街",   zone:"daini_jukyo" },{ pattern:"住宅地", zone:"daini_jukyo" },
  { pattern:"工業団地", zone:"jun_kogyo" },{ pattern:"臨海",   zone:"jun_kogyo" },
];

const MUNICIPALITY_ZONES = {
  shinjuku:"shogyo", shibuya:"shogyo", minato:"shogyo", ota:"jun_kogyo",
  taito:"shogyo", chiyoda:"shogyo", toshima:"kinrin_shogyo", sumida:"kinrin_shogyo",
  osaka_city:"shogyo", kyoto_city:"kinrin_shogyo", sapporo:"kinrin_shogyo",
  fukuoka_city:"shogyo", naha:"kinrin_shogyo",
};

const MARKET_DATA = {
  shinjuku: { areaName:"新宿エリア", source:"Inside Airbnb (2024) / 新宿区 掲載2,897件", rates:{"ワンルーム":[8000,13000],"1K":[9000,14000],"1DK":[10000,16000],"1LDK":[13000,22000],"2LDK":[20000,35000],"3LDK":[28000,50000]}, occupancy:[40,70], avgStay:2.0, cleaning:{small:[4000,6000],large:[7000,12000]} },
  shibuya:  { areaName:"渋谷エリア", source:"Inside Airbnb (2024) / 渋谷区 中央値20,349円", rates:{"ワンルーム":[10000,16000],"1K":[10000,16000],"1DK":[12000,20000],"1LDK":[15000,27000],"2LDK":[22000,40000],"3LDK":[32000,55000]}, occupancy:[40,70], avgStay:2.0, cleaning:{small:[4000,7000],large:[7000,12000]} },
  minato:   { areaName:"港区エリア", source:"Inside Airbnb (2024) / 港区", rates:{"ワンルーム":[10000,17000],"1K":[10000,17000],"1DK":[13000,20000],"1LDK":[16000,28000],"2LDK":[25000,42000],"3LDK":[35000,60000]}, occupancy:[40,68], avgStay:2.5, cleaning:{small:[4500,7000],large:[8000,13000]} },
  ota:      { areaName:"大田区エリア（羽田空港近く）", source:"Inside Airbnb (2024) / 大田区 特区民泊あり", rates:{"ワンルーム":[6000,10000],"1K":[7000,11000],"1DK":[8000,13000],"1LDK":[10000,17000],"2LDK":[15000,25000],"3LDK":[20000,35000]}, occupancy:[40,65], avgStay:2.5, cleaning:{small:[3500,5500],large:[6000,10000]} },
  taito:    { areaName:"台東区エリア（浅草・上野）", source:"Inside Airbnb (2024) / 台東区 掲載1,711件", rates:{"ワンルーム":[8000,13000],"1K":[8000,14000],"1DK":[10000,16000],"1LDK":[13000,22000],"2LDK":[18000,32000],"3LDK":[25000,48000]}, occupancy:[45,75], avgStay:2.0, cleaning:{small:[4000,6000],large:[7000,11000]} },
  chiyoda:  { areaName:"千代田区エリア", source:"Inside Airbnb (2024) / 千代田区", rates:{"ワンルーム":[10000,16000],"1K":[10000,17000],"1DK":[12000,19000],"1LDK":[15000,26000],"2LDK":[22000,38000],"3LDK":[30000,50000]}, occupancy:[38,65], avgStay:2.0, cleaning:{small:[4500,7000],large:[8000,13000]} },
  toshima:  { areaName:"豊島区エリア（池袋）", source:"Inside Airbnb (2024) / 豊島区", rates:{"ワンルーム":[7000,11000],"1K":[7000,12000],"1DK":[9000,14000],"1LDK":[11000,18000],"2LDK":[16000,28000],"3LDK":[22000,40000]}, occupancy:[42,70], avgStay:2.0, cleaning:{small:[3500,5500],large:[6000,10000]} },
  sumida:   { areaName:"墨田区エリア（スカイツリー）", source:"Inside Airbnb (2024) / 墨田区 掲載1,945件", rates:{"ワンルーム":[7000,11000],"1K":[7000,12000],"1DK":[9000,14000],"1LDK":[11000,18000],"2LDK":[16000,28000],"3LDK":[22000,40000]}, occupancy:[42,72], avgStay:2.0, cleaning:{small:[3500,5500],large:[6000,10000]} },
  osaka_city:{ areaName:"大阪市エリア", source:"Airbnb掲載データ (2024-2025) / 難波・梅田10,000円前後", rates:{"ワンルーム":[6000,9000],"1K":[6000,10000],"1DK":[7000,12000],"1LDK":[9000,15000],"2LDK":[14000,25000],"3LDK":[20000,38000]}, occupancy:[45,75], avgStay:2.0, cleaning:{small:[3000,5000],large:[5500,9000]} },
  kyoto_city:{ areaName:"京都市エリア", source:"Airbnb掲載データ (2024-2025) / 祇園等15,000-20,000円", rates:{"ワンルーム":[7000,12000],"1K":[7000,13000],"1DK":[9000,16000],"1LDK":[12000,20000],"2LDK":[18000,35000],"3LDK":[25000,50000]}, occupancy:[35,65], avgStay:2.0, cleaning:{small:[3500,5500],large:[6000,10000]} },
  sapporo:  { areaName:"札幌市エリア", source:"民泊運営各社データ (2024-2025) / 冬季スキーシーズン需要大", rates:{"ワンルーム":[5000,8000],"1K":[5000,9000],"1DK":[6000,11000],"1LDK":[8000,14000],"2LDK":[12000,22000],"3LDK":[17000,32000]}, occupancy:[35,60], avgStay:2.5, cleaning:{small:[3000,5000],large:[5000,8000]} },
  fukuoka_city:{ areaName:"福岡市エリア", source:"民泊運営各社データ (2024-2025) / 博多・天神エリア", rates:{"ワンルーム":[5000,9000],"1K":[6000,10000],"1DK":[7000,12000],"1LDK":[9000,16000],"2LDK":[14000,25000],"3LDK":[19000,35000]}, occupancy:[40,68], avgStay:2.0, cleaning:{small:[3000,5000],large:[5500,9000]} },
  naha:     { areaName:"那覇市エリア", source:"民泊運営各社データ (2024-2025) / 国際通り周辺", rates:{"ワンルーム":[5000,9000],"1K":[6000,10000],"1DK":[7000,12000],"1LDK":[9000,16000],"2LDK":[14000,26000],"3LDK":[20000,38000]}, occupancy:[40,68], avgStay:2.5, cleaning:{small:[3000,5000],large:[5500,9000]} },
  _default: { areaName:"全国平均（目安）", source:"各種データの平均値", rates:{"ワンルーム":[6000,10000],"1K":[6000,10000],"1DK":[7000,12000],"1LDK":[10000,16000],"2LDK":[15000,25000],"3LDK":[20000,35000]}, occupancy:[35,60], avgStay:2.0, cleaning:{small:[3000,5000],large:[5500,9000]} },
};

/* ===================================================================
   ヘルパー
   =================================================================== */
const getLayoutSize = (l) => ["ワンルーム","1K","1DK"].includes(l) ? "small" : "large";
const getCapacity = (l) => ({"ワンルーム":2,"1K":2,"1DK":2,"1LDK":3,"2K":3,"2DK":4,"2LDK":5,"3K":4,"3DK":5,"3LDK":7,"4LDK以上":9})[l]||4;
const fmt = (n) => (n==null||isNaN(n)) ? "—" : Math.round(n).toLocaleString("ja-JP");
const fmtMan = (n) => (n==null||isNaN(n)) ? "—" : (n/10000).toFixed(1)+"万";
const fmtMonth = (n) => { if(!n||n<=0) return "—"; const y=Math.floor(n/12),m=Math.round(n%12); return y===0?`${m}ヶ月`:m===0?`${y}年`:`${y}年${m}ヶ月`; };
const findRate = (mkt,layout) => { if(mkt.rates[layout]) return mkt.rates[layout]; const fb={"2K":"1LDK","2DK":"2LDK","3K":"2LDK","3DK":"3LDK","4LDK以上":"3LDK"}; return mkt.rates[fb[layout]]||mkt.rates["1LDK"]; };
const findZone = (addr,muniId) => { for(const k of ZONING_KEYWORDS){ if(addr.includes(k.pattern)) return {zone:k.zone,method:"keyword",keyword:k.pattern}; } if(muniId&&MUNICIPALITY_ZONES[muniId]) return {zone:MUNICIPALITY_ZONES[muniId],method:"municipality"}; return null; };

/* ===================================================================
   UIパーツ
   =================================================================== */
const Field = ({label,value,onChange,type="number",unit,placeholder,help,options,disabled}) => (
  <div className="mb-3">
    <label className="block text-xs font-semibold text-gray-500 mb-1">{label}</label>
    <div className="flex items-center gap-2">
      {options ? (
        <select value={value} onChange={e=>onChange(e.target.value)} disabled={disabled}
          className="w-full border border-gray-200 rounded-lg px-3 py-2.5 text-sm bg-white focus:ring-2 focus:ring-blue-400 focus:border-blue-400">
          {options.map(o=><option key={o.value??o} value={o.value??o}>{o.label??o}</option>)}
        </select>
      ) : (
        <input type={type} value={value} onChange={e=>onChange(type==="number"?(e.target.value===""?"":Number(e.target.value)):e.target.value)}
          placeholder={placeholder} disabled={disabled}
          className="w-full border border-gray-200 rounded-lg px-3 py-2.5 text-sm bg-white focus:ring-2 focus:ring-blue-400 focus:border-blue-400" />
      )}
      {unit && <span className="text-xs text-gray-400 whitespace-nowrap">{unit}</span>}
    </div>
    {help && <p className="text-xs text-gray-400 mt-0.5">{help}</p>}
  </div>
);

const Tag = ({color="gray",children}) => {
  const c={green:"bg-emerald-50 text-emerald-700 border-emerald-200",red:"bg-red-50 text-red-600 border-red-200",yellow:"bg-amber-50 text-amber-700 border-amber-200",blue:"bg-blue-50 text-blue-600 border-blue-200",purple:"bg-violet-50 text-violet-700 border-violet-200",gray:"bg-gray-50 text-gray-500 border-gray-200"};
  return <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold border ${c[color]||c.gray}`}>{children}</span>;
};

const Card = ({num,title,tag,accent="blue",children}) => (
  <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-5 mb-5">
    <div className="flex items-center gap-2 mb-4">
      {num && <span className={`w-7 h-7 ${accent==="purple"?"bg-violet-500":accent==="green"?"bg-emerald-500":"bg-blue-500"} text-white rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0`}>{num}</span>}
      <h2 className="text-sm font-bold text-gray-800">{title}</h2>
      {tag}
    </div>
    {children}
  </div>
);

const Light = ({ok,label,detail}) => (
  <div className="flex items-start gap-2.5 py-1.5">
    <span className={`w-3 h-3 rounded-full mt-0.5 flex-shrink-0 ${ok===true?"bg-emerald-400":ok===false?"bg-red-400":"bg-gray-300"}`} />
    <div>
      <span className="text-sm font-semibold text-gray-800">{label}</span>
      <span className={`ml-2 text-xs font-bold ${ok===true?"text-emerald-600":ok===false?"text-red-500":"text-gray-400"}`}>
        {ok===true?"取得可能性あり":ok===false?"不可":"要確認"}
      </span>
      {detail && <p className="text-xs text-gray-500 mt-0.5">{detail}</p>}
    </div>
  </div>
);

const Metric = ({label,value,sub,color="text-gray-800"}) => (
  <div className="bg-white rounded-xl border border-gray-100 shadow-sm p-4 text-center">
    <p className="text-xs text-gray-500 mb-1">{label}</p>
    <p className={`text-lg font-bold ${color}`}>{value}</p>
    {sub && <p className="text-xs text-gray-400 mt-0.5">{sub}</p>}
  </div>
);

/* ===================================================================
   メインコンポーネント
   =================================================================== */
function MinpakuSimulator() {
  const [tab, setTab] = useState(0);
  const tabNames = ["物件情報","収益シミュレーション","法規制チェック"];

  const [prop, setProp] = useState({
    address:"", layout:"1LDK", capacity:4,
    propertyType:"rent", purchasePrice:0, monthlyRent:100000,
    renovationCost:500000, furnitureCost:500000, otherInitialCost:200000, monthlyLoan:0,
    monthlyManagement:10000, monthlyUtilities:15000, monthlyInsurance:5000, monthlyOther:5000,
    cleaningFee:5000, linenFee:2000, consumablesFee:1000,
    avgStayLength:2, nightlyRate:12000, commissionRate:15,
    guestCleaningFee:0, useMonthlyMode:false,
    monthlyOccupancy:[70,70,70,70,70,70,70,70,70,70,70,70],
    monthlyNightlyRate:null,
  });
  const [legal, setLegal] = useState({ zone:"unknown", municipality:"none", buildingType:"mansion", isResidentialZone:false });
  const [auto_, setAuto] = useState({ municipality:null, marketData:null, coordinates:null, geoStatus:null, zoneSugg:null, mktApplied:false });
  const [showOverride, setShowOverride] = useState(false);

  const up = (k,v) => setProp(p=>({...p,[k]:v}));
  const upL = (k,v) => setLegal(p=>{ const n={...p,[k]:v}; if(k==="zone") n.isResidentialZone=v.includes("teiso")||v.includes("chukoso"); return n; });

  // --- 住所→自治体・相場・用途地域 ---
  useEffect(()=>{
    const a=prop.address.trim();
    if(a.length<2){ setAuto(p=>({...p,municipality:null,marketData:null,zoneSugg:null,mktApplied:false})); return; }
    let muni=null;
    for(const ap of ADDRESS_PATTERNS){ if(a.includes(ap.pattern)){muni=ap.muniId;break;} }
    const mkt=muni&&MARKET_DATA[muni]?MARKET_DATA[muni]:(a.length>=4?MARKET_DATA._default:null);
    const zs=findZone(a,muni);
    setAuto(p=>({...p, municipality:muni, marketData:mkt, zoneSugg:zs, mktApplied:p.municipality!==muni?false:p.mktApplied }));
    if(muni) setLegal(p=>({...p,municipality:muni}));
    if(zs) setLegal(p=>{ if(p.zone==="unknown"){const n={...p,zone:zs.zone}; n.isResidentialZone=zs.zone.includes("teiso")||zs.zone.includes("chukoso"); return n;} return p; });
  },[prop.address]);

  // --- 市場データ自動適用 ---
  useEffect(()=>{
    if(auto_.marketData && !auto_.mktApplied){
      const r=findRate(auto_.marketData,prop.layout);
      setProp(p=>({...p, nightlyRate:Math.round((r[0]+r[1])/2), avgStayLength:auto_.marketData.avgStay }));
      setAuto(p=>({...p,mktApplied:true}));
    }
  },[auto_.marketData, auto_.mktApplied, prop.layout]);

  // --- ジオコーディング ---
  const geocode = useCallback(async()=>{
    const a=prop.address.trim(); if(a.length<4) return;
    setAuto(p=>({...p,geoStatus:"loading"}));
    try{
      const res=await fetch(`https://msearch.gsi.go.jp/address-search/AddressSearch?q=${encodeURIComponent(a)}`);
      const d=await res.json();
      if(d&&d.length>0&&d[0].geometry){ const [lng,lat]=d[0].geometry.coordinates; setAuto(p=>({...p,coordinates:{lat,lng},geoStatus:"found"})); }
      else setAuto(p=>({...p,geoStatus:"notfound"}));
    } catch(e){ setAuto(p=>({...p,geoStatus:"error"})); }
  },[prop.address]);
  useEffect(()=>{ if(prop.address.trim().length>=4){const t=setTimeout(geocode,800);return()=>clearTimeout(t);} },[prop.address,geocode]);

  // --- 間取り→定員 + 相場再適用 ---
  useEffect(()=>{
    setProp(p=>({...p,capacity:getCapacity(p.layout)}));
    if(auto_.marketData) setAuto(p=>({...p,mktApplied:false}));
  },[prop.layout]);

  // --- URL ---
  const airbnbUrl = useMemo(()=>{
    if(auto_.coordinates){const{lat,lng}=auto_.coordinates; return `https://www.airbnb.jp/s/homes?ne_lat=${(lat+.02).toFixed(4)}&ne_lng=${(lng+.02).toFixed(4)}&sw_lat=${(lat-.02).toFixed(4)}&sw_lng=${(lng-.02).toFixed(4)}&zoom=15`;}
    if(prop.address.trim()) return `https://www.airbnb.jp/s/${encodeURIComponent(prop.address.trim())}/homes`; return null;
  },[auto_.coordinates,prop.address]);
  const zoningUrl = useMemo(()=> auto_.coordinates ? `https://www.reinfolib.mlit.go.jp/CityPlanMap/?lat=${auto_.coordinates.lat.toFixed(5)}&lng=${auto_.coordinates.lng.toFixed(5)}&zoom=16` : "https://www.reinfolib.mlit.go.jp/CityPlanMap/",[auto_.coordinates]);

  // --- 収益計算 ---
  const R = useMemo(()=>{
    const muni=MUNICIPALITIES.find(m=>m.id===legal.municipality)||MUNICIPALITIES[0];
    const isRes=legal.zone.includes("teiso")||legal.zone.includes("chukoso");
    let mDays=muni.minpakuDays||180; if(isRes&&muni.residentialDays) mDays=muni.residentialDays;
    const init=(prop.propertyType==="purchase"?prop.purchasePrice:0)+prop.renovationCost+prop.furnitureCost+prop.otherInitialCost;
    const mFix=(prop.propertyType==="rent"?prop.monthlyRent:prop.monthlyLoan)+prop.monthlyManagement+prop.monthlyUtilities+prop.monthlyInsurance+prop.monthlyOther;
    const aFix=mFix*12;
    const calc=(days)=>(rate)=>{
      const occ=Math.round(days*rate),turns=Math.ceil(occ/Math.max(prop.avgStayLength,1));
      const g=occ*prop.nightlyRate,comm=g*(prop.commissionRate/100);
      const cleanIncome=turns*prop.guestCleaningFee*(1-prop.commissionRate/100);
      const vc=turns*(prop.cleaningFee+prop.linenFee+prop.consumablesFee)-cleanIncome;
      const net=g-comm,profit=net-vc-aFix;
      return{occupied:occ,gross:g,netRevenue:net,variableCost:vc,cleanIncome,profit,monthlyProfit:profit/12,payback:profit>0&&init>0?init/profit:null};
    };
    const scenarios=OCCUPANCY_RATES.map(r=>({rate:Math.round(r*100),minpaku:calc(mDays)(r),ryokan:calc(365)(r)}));
    const be=(days)=>{const nn=prop.nightlyRate*(1-prop.commissionRate/100),gcf=prop.guestCleaningFee*(1-prop.commissionRate/100)/Math.max(prop.avgStayLength,1),vpn=(prop.cleaningFee+prop.linenFee+prop.consumablesFee)/Math.max(prop.avgStayLength,1)-gcf,npn=nn-vpn; if(npn<=0)return null; const b=aFix/(npn*days); return b<=1?b:null;};
    const gy=prop.propertyType==="purchase"&&prop.purchasePrice>0?(prop.nightlyRate*365*.6/prop.purchasePrice*100):null;

    // Monthly calculation
    const monthly = prop.useMonthlyMode ? DAYS_IN_MONTH.map((days, i) => {
      const rate = (prop.monthlyOccupancy[i] || 70) / 100;
      const nRate = prop.monthlyNightlyRate ? prop.monthlyNightlyRate[i] : prop.nightlyRate;
      const occ = Math.round(days * rate);
      const turns = Math.ceil(occ / Math.max(prop.avgStayLength, 1));
      const gross = occ * nRate;
      const comm = gross * (prop.commissionRate / 100);
      const cleanIncome = turns * prop.guestCleaningFee * (1 - prop.commissionRate / 100);
      const vc = turns * (prop.cleaningFee + prop.linenFee + prop.consumablesFee) - cleanIncome;
      const net = gross - comm;
      const profit = net - vc - mFix;
      return { month: i+1, label: MONTH_LABELS[i], days, rate: prop.monthlyOccupancy[i], occ, turns, nRate, gross, comm, net, vc, cleanIncome, mFix: mFix, profit };
    }) : null;
    const monthlyTotal = monthly ? {
      occ: monthly.reduce((s,m)=>s+m.occ,0), gross: monthly.reduce((s,m)=>s+m.gross,0),
      net: monthly.reduce((s,m)=>s+m.net,0), vc: monthly.reduce((s,m)=>s+m.vc,0),
      profit: monthly.reduce((s,m)=>s+m.profit,0), cleanIncome: monthly.reduce((s,m)=>s+m.cleanIncome,0),
      avgRate: Math.round(monthly.reduce((s,m)=>s+m.rate,0)/12),
    } : null;

    return{init,mFix,aFix,mDays,scenarios,beM:be(mDays),beR:be(365),gy,monthly,monthlyTotal};
  },[prop,legal]);

  const LR = useMemo(()=>({zone:ZONES.find(z=>z.id===legal.zone),muni:MUNICIPALITIES.find(m=>m.id===legal.municipality)||MUNICIPALITIES[0],isRes:legal.zone.includes("teiso")||legal.zone.includes("chukoso")}),[legal]);
  const chart = R.scenarios.map(s=>({name:`${s.rate}%`,"民泊新法":Math.round(s.minpaku.profit/10000),"旅館業":Math.round(s.ryokan.profit/10000)}));
  const mkt = auto_.marketData||MARKET_DATA._default;
  const rateRange = findRate(mkt,prop.layout);

  // --- PDF ---
  const exportPdf = () => {
    const th=`<tr style="background:#f8fafc;font-size:11px"><th>稼働率</th><th>日数</th><th>売上</th><th>変動費</th><th>年間利益</th><th>月利益</th><th>回収</th></tr>`;
    const row=(s,t,c)=>`<tr><td>${s.rate}%</td><td>${s[t].occupied}日</td><td>${fmt(s[t].netRevenue)}円</td><td>${fmt(s[t].variableCost)}円</td><td style="font-weight:700;color:${s[t].profit>=0?c:'#dc2626'}">${fmt(s[t].profit)}円</td><td>${fmt(s[t].monthlyProfit)}円</td><td>${s[t].payback?fmtMonth(s[t].payback*12):'—'}</td></tr>`;
    const html=`<!DOCTYPE html><html><head><meta charset="utf-8"><title>民泊シミュレーション</title><style>body{font-family:'Hiragino Sans','Yu Gothic',sans-serif;margin:30px 40px;color:#1e293b;font-size:13px;line-height:1.6}h1{font-size:18px;border-bottom:2px solid #3b82f6;padding-bottom:8px}h2{font-size:14px;margin-top:22px;color:#1e40af;border-left:4px solid #3b82f6;padding-left:8px}table{width:100%;border-collapse:collapse;margin:8px 0 14px;font-size:11px}th,td{border:1px solid #e2e8f0;padding:5px 8px;text-align:right}th{background:#f8fafc;text-align:center}td:first-child{text-align:center;font-weight:600}.g{display:grid;grid-template-columns:1fr 1fr;gap:4px 20px;margin:8px 0}.gi{display:flex;justify-content:space-between;border-bottom:1px dotted #e2e8f0;padding:3px 0}.gl{color:#64748b}.gv{font-weight:600}.n{background:#fffbeb;border:1px solid #fde68a;border-radius:6px;padding:8px 12px;margin:8px 0;font-size:11px}.ft{margin-top:28px;border-top:1px solid #e2e8f0;padding-top:8px;font-size:10px;color:#94a3b8;text-align:center}@media print{body{margin:15px 20px}}</style></head><body>
<h1>民泊物件 シミュレーション結果</h1><p style="color:#64748b;font-size:11px">作成日: ${new Date().toLocaleDateString('ja-JP')}</p>
<h2>物件情報</h2><div class="g"><div class="gi"><span class="gl">住所</span><span class="gv">${prop.address||'未入力'}</span></div><div class="gi"><span class="gl">間取り/定員</span><span class="gv">${prop.layout}/${prop.capacity}人</span></div><div class="gi"><span class="gl">形態</span><span class="gv">${prop.propertyType==='rent'?'賃貸':'購入'}</span></div><div class="gi"><span class="gl">${prop.propertyType==='rent'?'家賃':'購入価格'}</span><span class="gv">${prop.propertyType==='rent'?fmt(prop.monthlyRent)+'円/月':fmt(prop.purchasePrice)+'円'}</span></div><div class="gi"><span class="gl">初期投資</span><span class="gv">${fmt(R.init)}円</span></div><div class="gi"><span class="gl">固定費</span><span class="gv">${fmt(R.mFix)}円/月</span></div><div class="gi"><span class="gl">宿泊単価</span><span class="gv">${fmt(prop.nightlyRate)}円/泊</span></div><div class="gi"><span class="gl">清掃費</span><span class="gv">${fmt(prop.cleaningFee)}円/回</span></div>${prop.guestCleaningFee>0?`<div class="gi"><span class="gl">ゲスト清掃費</span><span class="gv">${fmt(prop.guestCleaningFee)}円/泊</span></div>`:''}<div class="gi"><span class="gl">用途地域</span><span class="gv">${LR.zone?.label||'未選択'}</span></div><div class="gi"><span class="gl">自治体</span><span class="gv">${LR.muni.label}</span></div></div>
${R.monthly ? `<h2>月別収支シミュレーション</h2><table><tr style="background:#f8fafc;font-size:11px"><th>月</th><th>稼働率</th><th>稼働日</th><th>単価</th><th>売上</th><th>手数料</th><th>変動費</th><th>固定費</th><th>利益</th></tr>${R.monthly.map(m=>`<tr><td style="text-align:center;font-weight:600">\${m.label}</td><td style="text-align:right">\${m.rate}%</td><td style="text-align:right">\${m.occ}日</td><td style="text-align:right">\${fmt(m.nRate)}円</td><td style="text-align:right">\${fmt(m.gross)}円</td><td style="text-align:right">\${fmt(m.comm)}円</td><td style="text-align:right">\${fmt(m.vc)}円</td><td style="text-align:right">\${fmt(m.mFix)}円</td><td style="text-align:right;font-weight:700;color:\${m.profit>=0?'#2563eb':'#dc2626'}">\${fmt(m.profit)}円</td></tr>`).join('')}<tr style="border-top:2px solid #94a3b8;font-weight:700;background:#f8fafc"><td style="text-align:center">合計</td><td style="text-align:right">${R.monthlyTotal.avgRate}%</td><td style="text-align:right">${R.monthlyTotal.occ}日</td><td style="text-align:right">—</td><td style="text-align:right">${fmt(R.monthlyTotal.gross)}円</td><td style="text-align:right">${fmt(R.monthlyTotal.gross*(prop.commissionRate/100))}円</td><td style="text-align:right">${fmt(R.monthlyTotal.vc)}円</td><td style="text-align:right">${fmt(R.aFix)}円</td><td style="text-align:right;color:${R.monthlyTotal.profit>=0?'#2563eb':'#dc2626'}">${fmt(R.monthlyTotal.profit)}円</td></tr></table>` : `<h2>民泊新法 — 年間${R.mDays}日</h2><table>${th}${R.scenarios.map(s=>row(s,"minpaku","#2563eb")).join("")}</table>
<h2>旅館業法 — 年間365日</h2><table>${th}${R.scenarios.map(s=>row(s,"ryokan","#059669")).join("")}</table>`}
${LR.muni.restriction?`<div class="n"><strong>${LR.muni.label}:</strong> ${LR.muni.restriction}</div>`:''}
<div class="ft">※概算シミュレーション。投資判断は自己責任で。法規制は管轄の保健所にご確認ください。</div></body></html>`;
    const w=window.open("","_blank"); if(w){w.document.write(html);w.document.close();setTimeout(()=>w.print(),500);}
  };

  /* =================================================================
     レンダリング
     ================================================================= */
  return (
    <div className="min-h-screen bg-gradient-to-b from-slate-50 to-blue-50">
      {/* ヘッダー */}
      <div className="bg-white border-b border-gray-100 shadow-sm sticky top-0 z-10">
        <div className="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
          <div><h1 className="text-base font-bold text-gray-800">民泊物件シミュレーター</h1><p className="text-xs text-gray-400">住所入力で自動検出 / 収益予測・法規制チェック</p></div>
          <button type="button" onClick={exportPdf} className="px-4 py-2 bg-red-500 text-white rounded-lg text-xs font-bold hover:bg-red-600 transition shadow-sm">PDF出力</button>
        </div>
        <div className="max-w-4xl mx-auto px-4"><div className="flex">
          {tabNames.map((t,i)=><button key={i} onClick={()=>setTab(i)} className={`px-5 py-2.5 text-xs font-semibold border-b-2 transition ${tab===i?"border-blue-500 text-blue-600":"border-transparent text-gray-400 hover:text-gray-600"}`}>{t}</button>)}
        </div></div>
      </div>

      <div className="max-w-4xl mx-auto px-4 py-5">

      {/* ============= Tab 1: 物件情報 ============= */}
      {tab===0 && (<div>
        <Card num="1" title="基本情報" tag={auto_.municipality&&<Tag color="purple">自動検出あり</Tag>}>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6">
            <div>
              <Field label="住所" value={prop.address} onChange={v=>up("address",v)} type="text" placeholder="例: 東京都新宿区歌舞伎町1-1-1" help="住所を入力すると自治体・相場・用途地域を自動検出" />
              <div className="flex flex-wrap gap-1.5 mb-3 -mt-1">
                {auto_.municipality&&<Tag color="purple">{MUNICIPALITIES.find(m=>m.id===auto_.municipality)?.label}</Tag>}
                {auto_.geoStatus==="found"&&<Tag color="green">座標取得済</Tag>}
                {auto_.geoStatus==="loading"&&<Tag color="blue">検索中...</Tag>}
                {auto_.zoneSugg&&<Tag color="yellow">用途地域推定: {ZONES.find(z=>z.id===auto_.zoneSugg.zone)?.label}{auto_.zoneSugg.method==="keyword"?` (${auto_.zoneSugg.keyword})`:""}</Tag>}
                {auto_.mktApplied&&<Tag color="green">相場反映済</Tag>}
              </div>
              <div className="grid grid-cols-2 gap-3">
                <Field label="間取り" value={prop.layout} onChange={v=>up("layout",v)} options={LAYOUTS.map(l=>({value:l,label:l}))} />
                <Field label="定員数" value={prop.capacity} onChange={v=>up("capacity",v)} unit="人" />
              </div>
            </div>
            <div>
              <Field label="用途地域" value={legal.zone} onChange={v=>upL("zone",v)} options={ZONES.map(z=>({value:z.id,label:z.label}))} help={auto_.zoneSugg?`住所から「${ZONES.find(z=>z.id===auto_.zoneSugg.zone)?.label}」を自動設定`:"不動産情報ライブラリで確認できます"} />
              <a href={zoningUrl} target="_blank" rel="noopener noreferrer" className="inline-block text-xs text-blue-500 hover:text-blue-700 -mt-2 mb-3 underline decoration-dotted">用途地域を地図で確認</a>
              <Field label="自治体" value={legal.municipality} onChange={v=>upL("municipality",v)} options={MUNICIPALITIES.map(m=>({value:m.id,label:m.label}))} help={auto_.municipality?"住所から自動検出":""} />
              <Field label="建物種別" value={legal.buildingType} onChange={v=>upL("buildingType",v)} options={[{value:"mansion",label:"マンション・集合住宅"},{value:"house",label:"一戸建て"}]} />
            </div>
          </div>
          {legal.zone!=="unknown"&&(
            <div className="mt-3 p-3 bg-gray-50 rounded-xl border border-gray-100">
              <p className="text-xs font-semibold text-gray-500 mb-1">法規制クイックチェック</p>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-0">
                <Light ok={LR.zone?.minpaku} label="民泊新法" detail={`年間${R.mDays}日まで${LR.muni?.restriction?' / '+LR.muni.restriction:''}`} />
                <Light ok={LR.zone?.ryokan} label="旅館業法" detail={LR.zone?.ryokan===true?"年間365日営業可能":LR.zone?.note||""} />
              </div>
              {LR.muni?.tokku&&<p className="text-xs text-blue-600 mt-1 pl-5">{LR.muni.tokkuNote}</p>}
              {legal.buildingType==="mansion"&&<p className="text-xs text-amber-600 mt-1 pl-5">* マンションの場合、管理規約で民泊禁止がないか確認が必要</p>}
            </div>
          )}
        </Card>

        <Card title="市場参考データ" tag={<Tag color="purple">{mkt.areaName}</Tag>} accent="purple">
          <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
            {[
              ["宿泊単価の相場",`${fmt(rateRange[0])}〜${fmt(rateRange[1])}円`,`${prop.layout}/1泊`],
              ["想定稼働率",`${mkt.occupancy[0]}〜${mkt.occupancy[1]}%`],
              ["清掃費の相場",`${fmt(mkt.cleaning[getLayoutSize(prop.layout)][0])}〜${fmt(mkt.cleaning[getLayoutSize(prop.layout)][1])}円`],
              ["平均宿泊日数",`${mkt.avgStay}泊`],
            ].map(([l,v,s],i)=>(
              <div key={i} className="bg-violet-50 rounded-xl p-3">
                <p className="text-xs text-violet-500 font-medium">{l}</p>
                <p className="text-sm font-bold text-gray-800 mt-1">{v}</p>
                {s&&<p className="text-xs text-gray-400">{s}</p>}
              </div>
            ))}
          </div>
          <div className="flex flex-wrap items-center gap-3">
            {airbnbUrl&&<a href={airbnbUrl} target="_blank" rel="noopener noreferrer" className="px-3 py-1.5 bg-white border border-pink-200 rounded-lg text-xs font-medium text-pink-600 hover:bg-pink-50 transition">Airbnbで実際の相場を確認</a>}
            {mkt.source&&<p className="text-xs text-gray-400">出典: {mkt.source}</p>}
          </div>
        </Card>

        <Card num="2" title="物件取得・初期費用">
          <div className="flex gap-2 mb-4">
            {[["rent","賃貸（転貸型）"],["purchase","購入（所有型）"]].map(([v,l])=>(
              <button key={v} onClick={()=>up("propertyType",v)} className={`px-4 py-2 rounded-lg text-xs font-semibold transition ${prop.propertyType===v?"bg-blue-500 text-white shadow-sm":"bg-gray-100 text-gray-500 hover:bg-gray-200"}`}>{l}</button>
            ))}
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6">
            {prop.propertyType==="purchase"?<><Field label="物件購入価格" value={prop.purchasePrice} onChange={v=>up("purchasePrice",v)} unit="円" /><Field label="月々のローン返済額" value={prop.monthlyLoan} onChange={v=>up("monthlyLoan",v)} unit="円/月" /></>:<Field label="月額家賃" value={prop.monthlyRent} onChange={v=>up("monthlyRent",v)} unit="円/月" />}
            <Field label="リフォーム・内装費" value={prop.renovationCost} onChange={v=>up("renovationCost",v)} unit="円" />
            <Field label="家具・備品費" value={prop.furnitureCost} onChange={v=>up("furnitureCost",v)} unit="円" />
            <Field label="その他初期費用" value={prop.otherInitialCost} onChange={v=>up("otherInitialCost",v)} unit="円" help="仲介手数料、保証金、届出費用など" />
          </div>
          {R.init>0&&<div className="mt-3 px-4 py-2.5 bg-slate-50 rounded-xl"><p className="text-sm text-gray-700">初期投資合計: <span className="font-bold text-gray-900">{fmt(R.init)}円</span></p></div>}
        </Card>

        <Card num="3" title="月額固定費">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6">
            <Field label="管理費・共益費" value={prop.monthlyManagement} onChange={v=>up("monthlyManagement",v)} unit="円/月" />
            <Field label="光熱費（平均）" value={prop.monthlyUtilities} onChange={v=>up("monthlyUtilities",v)} unit="円/月" />
            <Field label="火災保険等" value={prop.monthlyInsurance} onChange={v=>up("monthlyInsurance",v)} unit="円/月" />
            <Field label="その他固定費" value={prop.monthlyOther} onChange={v=>up("monthlyOther",v)} unit="円/月" help="Wi-Fi、消防設備リース等" />
          </div>
          <div className="mt-3 px-4 py-2.5 bg-blue-50 rounded-xl"><p className="text-sm text-blue-800">月額固定費合計: <span className="font-bold">{fmt(R.mFix)}円/月</span>（年間 <span className="font-bold">{fmt(R.aFix)}円</span>）</p></div>
        </Card>

        <Card num="4" title="運営情報" tag={auto_.mktApplied&&<Tag color="green">相場から自動入力済</Tag>}>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6">
            <Field label="1泊あたり宿泊単価" value={prop.nightlyRate} onChange={v=>up("nightlyRate",v)} unit="円/泊" help={`相場: ${fmt(rateRange[0])}〜${fmt(rateRange[1])}円（平均値を自動入力）`} />
            <Field label="平均宿泊日数" value={prop.avgStayLength} onChange={v=>up("avgStayLength",v)} unit="泊" help="ゲスト1組あたりの平均（自動入力済）" />
            <Field label="清掃費（1回）" value={prop.cleaningFee} onChange={v=>up("cleaningFee",v)} unit="円/回" help={`相場: ${fmt(mkt.cleaning[getLayoutSize(prop.layout)][0])}〜${fmt(mkt.cleaning[getLayoutSize(prop.layout)][1])}円`} />
            <Field label="リネン費（1回）" value={prop.linenFee} onChange={v=>up("linenFee",v)} unit="円/回" />
            <Field label="消耗品費（1回）" value={prop.consumablesFee} onChange={v=>up("consumablesFee",v)} unit="円/回" help="アメニティ等" />
            <Field label="清掃費/泊（ゲスト徴収）" value={prop.guestCleaningFee} onChange={v=>up("guestCleaningFee",v)} unit="円/泊" help="Airbnbで設定可能。ゲストに請求する清掃費（OTA手数料控除後が収入になります）" />
            <Field label="OTA手数料率" value={prop.commissionRate} onChange={v=>up("commissionRate",v)} unit="%" help="Airbnb: 約3% / Booking.com: 約15%" />
          </div>
        </Card>

        <Card num="5" title="月別設定" tag={prop.useMonthlyMode&&<Tag color="green">月別モードON</Tag>}>
          <div className="flex gap-2 mb-4">
            {[["off","年間一律"],["on","月別設定"]].map(([v,l])=>(
              <button key={v} onClick={()=>up("useMonthlyMode",v==="on")} className={`px-4 py-2 rounded-lg text-xs font-semibold transition ${(v==="on"?prop.useMonthlyMode:!prop.useMonthlyMode)?"bg-blue-500 text-white shadow-sm":"bg-gray-100 text-gray-500 hover:bg-gray-200"}`}>{l}</button>
            ))}
          </div>
          {prop.useMonthlyMode && (<div>
            <div className="flex flex-wrap gap-2 mb-3">
              <span className="text-xs text-gray-500 leading-7">プリセット:</span>
              {Object.entries(MONTHLY_PRESETS).map(([k,p])=>(
                <button key={k} onClick={()=>up("monthlyOccupancy",[...p.values])} className="px-3 py-1.5 bg-violet-50 text-violet-600 rounded-lg text-xs font-medium hover:bg-violet-100 transition border border-violet-200">{p.label}</button>
              ))}
            </div>
            <div className="overflow-x-auto">
              <table className="w-full text-xs border-collapse">
                <thead><tr className="bg-slate-50">
                  <th className="px-1 py-2 font-semibold text-gray-500 text-center w-12">月</th>
                  {MONTH_LABELS.map((m,i)=><th key={i} className="px-1 py-2 font-semibold text-gray-500 text-center">{m}</th>)}
                </tr></thead>
                <tbody>
                  <tr className="border-t border-gray-100">
                    <td className="px-1 py-1.5 text-center text-gray-500 font-medium">稼働率%</td>
                    {prop.monthlyOccupancy.map((v,i)=><td key={i} className="px-0.5 py-1"><input type="number" value={v} onChange={e=>{const a=[...prop.monthlyOccupancy];a[i]=Number(e.target.value)||0;up("monthlyOccupancy",a);}} className="w-full text-center border border-gray-200 rounded px-1 py-1.5 text-xs focus:ring-1 focus:ring-blue-400" min="0" max="100" /></td>)}
                  </tr>
                  <tr className="border-t border-gray-100">
                    <td className="px-1 py-1.5 text-center text-gray-500 font-medium">単価</td>
                    {MONTH_LABELS.map((m,i)=><td key={i} className="px-0.5 py-1"><input type="number" value={prop.monthlyNightlyRate?prop.monthlyNightlyRate[i]:prop.nightlyRate} onChange={e=>{const a=prop.monthlyNightlyRate?[...prop.monthlyNightlyRate]:Array(12).fill(prop.nightlyRate);a[i]=Number(e.target.value)||0;up("monthlyNightlyRate",a);}} className="w-full text-center border border-gray-200 rounded px-1 py-1.5 text-xs focus:ring-1 focus:ring-blue-400" /></td>)}
                  </tr>
                </tbody>
              </table>
            </div>
            {prop.monthlyNightlyRate && <button onClick={()=>up("monthlyNightlyRate",null)} className="mt-2 text-xs text-blue-500 underline decoration-dotted">単価を全月統一に戻す（{fmt(prop.nightlyRate)}円）</button>}
            <p className="text-xs text-gray-400 mt-2">稼働率と単価を月ごとに調整できます。プリセットで一括設定も可能です。</p>
          </div>)}
          {!prop.useMonthlyMode && <p className="text-xs text-gray-400">月別モードをONにすると、月ごとの稼働率・単価を個別に設定できます。</p>}
        </Card>

        <div className="text-center mb-4">
          <button onClick={()=>setTab(1)} className="px-8 py-3 bg-blue-500 text-white rounded-xl text-sm font-bold shadow-md hover:bg-blue-600 transition">収益シミュレーションを見る</button>
        </div>
      </div>)}

      {/* ============= Tab 2: 収益シミュレーション ============= */}
      {tab===1 && (<div>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-5">
          <Metric label="初期投資額" value={`${fmtMan(R.init)}円`} />
          <Metric label="年間固定費" value={`${fmtMan(R.aFix)}円`} />
          {!prop.useMonthlyMode ? (<>
            <Metric label="損益分岐（民泊新法）" value={R.beM?`${Math.round(R.beM*100)}%`:"—"} color="text-blue-600" sub={`年間${R.mDays}日`} />
            <Metric label="損益分岐（旅館業）" value={R.beR?`${Math.round(R.beR*100)}%`:"—"} color="text-emerald-600" sub="年間365日" />
          </>) : (<>
            <Metric label="年間利益（月別合計）" value={`${fmtMan(R.monthlyTotal?.profit)}円`} color={R.monthlyTotal?.profit>=0?"text-blue-600":"text-red-500"} sub={`平均稼働率 ${R.monthlyTotal?.avgRate}%`} />
            <Metric label="月平均利益" value={`${fmt(Math.round((R.monthlyTotal?.profit||0)/12))}円`} color={R.monthlyTotal?.profit>=0?"text-emerald-600":"text-red-500"} />
          </>)}
        </div>
        {!prop.useMonthlyMode && R.gy&&<div className="mb-5 px-4 py-3 bg-amber-50 rounded-xl border border-amber-200"><p className="text-sm text-amber-800">表面利回り（稼働率60%想定）: <span className="font-bold text-lg">{R.gy.toFixed(1)}%</span></p></div>}

        {/* Monthly mode table */}
        {prop.useMonthlyMode && R.monthly && (<>
          <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-5 mb-5">
            <h3 className="text-sm font-bold text-gray-700 mb-3">月別収支シミュレーション</h3>
            <div className="overflow-x-auto"><table className="w-full text-xs border-collapse">
              <thead><tr className="bg-slate-50 text-gray-500">
                <th className="px-2 py-2 font-semibold text-center">月</th>
                <th className="px-2 py-2 text-right font-semibold">稼働率</th>
                <th className="px-2 py-2 text-right font-semibold">稼働日</th>
                <th className="px-2 py-2 text-right font-semibold">単価</th>
                <th className="px-2 py-2 text-right font-semibold">売上</th>
                <th className="px-2 py-2 text-right font-semibold">手数料</th>
                <th className="px-2 py-2 text-right font-semibold">変動費</th>
                <th className="px-2 py-2 text-right font-semibold">固定費</th>
                <th className="px-2 py-2 text-right font-semibold">利益</th>
              </tr></thead>
              <tbody>
                {R.monthly.map(m=><tr key={m.month} className="border-t border-gray-50 hover:bg-blue-50/30">
                  <td className="px-2 py-2 text-center font-bold text-gray-700">{m.label}</td>
                  <td className="px-2 py-2 text-right">{m.rate}%</td>
                  <td className="px-2 py-2 text-right">{m.occ}日</td>
                  <td className="px-2 py-2 text-right">{fmt(m.nRate)}円</td>
                  <td className="px-2 py-2 text-right">{fmt(m.gross)}円</td>
                  <td className="px-2 py-2 text-right text-gray-500">{fmt(m.comm)}円</td>
                  <td className="px-2 py-2 text-right text-gray-500">{fmt(m.vc)}円</td>
                  <td className="px-2 py-2 text-right text-gray-500">{fmt(m.mFix)}円</td>
                  <td className={`px-2 py-2 text-right font-bold ${m.profit>=0?"text-blue-600":"text-red-500"}`}>{fmt(m.profit)}円</td>
                </tr>)}
                <tr className="border-t-2 border-gray-300 bg-slate-50 font-bold">
                  <td className="px-2 py-2 text-center text-gray-800">合計</td>
                  <td className="px-2 py-2 text-right text-gray-600">{R.monthlyTotal.avgRate}%</td>
                  <td className="px-2 py-2 text-right">{R.monthlyTotal.occ}日</td>
                  <td className="px-2 py-2 text-right text-gray-400">—</td>
                  <td className="px-2 py-2 text-right">{fmt(R.monthlyTotal.gross)}円</td>
                  <td className="px-2 py-2 text-right text-gray-500">{fmt(R.monthlyTotal.gross*(prop.commissionRate/100))}円</td>
                  <td className="px-2 py-2 text-right text-gray-500">{fmt(R.monthlyTotal.vc)}円</td>
                  <td className="px-2 py-2 text-right text-gray-500">{fmt(R.aFix)}円</td>
                  <td className={`px-2 py-2 text-right font-bold ${R.monthlyTotal.profit>=0?"text-blue-600":"text-red-500"}`}>{fmt(R.monthlyTotal.profit)}円</td>
                </tr>
              </tbody>
            </table></div>
            {prop.guestCleaningFee>0 && <p className="text-xs text-gray-400 mt-2">※ ゲスト清掃費収入（{fmt(R.monthlyTotal.cleanIncome)}円/年）は変動費から控除済み</p>}
          </div>

          {/* Monthly profit chart */}
          <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-5 mb-5">
            <h3 className="text-sm font-bold text-gray-700 mb-3">月別利益推移</h3>
            <div className="space-y-1.5">
              {R.monthly.map(m => {
                const maxAbs = Math.max(...R.monthly.map(x=>Math.abs(x.profit))) || 1;
                return <div key={m.month} className="flex items-center gap-2 text-xs">
                  <span className="w-8 text-right text-gray-400 shrink-0">{m.label}</span>
                  <div className="flex-1 flex items-center">
                    <div className={`h-5 rounded-sm ${m.profit>=0?"bg-blue-500":"bg-red-400"}`} style={{width: Math.max(Math.abs(m.profit)/maxAbs*100,2)+"%",minWidth:"2px"}} />
                    <span className="ml-1.5 text-gray-500" style={{fontSize:10}}>{fmt(m.profit)}円</span>
                  </div>
                </div>;
              })}
            </div>
          </div>
        </>)}

        {/* Scenario mode */}
        {!prop.useMonthlyMode && (<>
        <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-5 mb-5">
          <h3 className="text-sm font-bold text-gray-700 mb-3">稼働率別 年間利益（万円）</h3>
          <SimpleBarChart data={chart} />
        </div>

        <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-5 mb-5">
          <div className="flex items-center gap-2 mb-3"><span className="w-3 h-3 bg-blue-500 rounded-full" /><h3 className="text-sm font-bold text-gray-700">民泊新法</h3><span className="text-xs text-gray-400">年間{R.mDays}日</span></div>
          <div className="overflow-x-auto"><table className="w-full text-xs">
            <thead><tr className="bg-slate-50 text-gray-500"><th className="px-2 py-2 font-semibold">稼働率</th><th className="px-2 py-2 text-right font-semibold">日数</th><th className="px-2 py-2 text-right font-semibold">売上</th><th className="px-2 py-2 text-right font-semibold">変動費</th><th className="px-2 py-2 text-right font-semibold">年間利益</th><th className="px-2 py-2 text-right font-semibold">月利益</th><th className="px-2 py-2 text-right font-semibold">投資回収</th></tr></thead>
            <tbody>{R.scenarios.map(s=><tr key={s.rate} className="border-t border-gray-50 hover:bg-blue-50/30">
              <td className="px-2 py-2 text-center font-bold">{s.rate}%</td><td className="px-2 py-2 text-right">{s.minpaku.occupied}日</td><td className="px-2 py-2 text-right">{fmt(s.minpaku.netRevenue)}円</td><td className="px-2 py-2 text-right">{fmt(s.minpaku.variableCost)}円</td>
              <td className={`px-2 py-2 text-right font-bold ${s.minpaku.profit>=0?"text-blue-600":"text-red-500"}`}>{fmt(s.minpaku.profit)}円</td><td className="px-2 py-2 text-right">{fmt(s.minpaku.monthlyProfit)}円</td><td className="px-2 py-2 text-right text-gray-500">{s.minpaku.payback?fmtMonth(s.minpaku.payback*12):"—"}</td>
            </tr>)}</tbody>
          </table></div>
        </div>

        <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-5 mb-5">
          <div className="flex items-center gap-2 mb-3"><span className="w-3 h-3 bg-emerald-500 rounded-full" /><h3 className="text-sm font-bold text-gray-700">旅館業法（簡易宿所）</h3><span className="text-xs text-gray-400">年間365日</span></div>
          <div className="overflow-x-auto"><table className="w-full text-xs">
            <thead><tr className="bg-slate-50 text-gray-500"><th className="px-2 py-2 font-semibold">稼働率</th><th className="px-2 py-2 text-right font-semibold">日数</th><th className="px-2 py-2 text-right font-semibold">売上</th><th className="px-2 py-2 text-right font-semibold">変動費</th><th className="px-2 py-2 text-right font-semibold">年間利益</th><th className="px-2 py-2 text-right font-semibold">月利益</th><th className="px-2 py-2 text-right font-semibold">投資回収</th></tr></thead>
            <tbody>{R.scenarios.map(s=><tr key={s.rate} className="border-t border-gray-50 hover:bg-emerald-50/30">
              <td className="px-2 py-2 text-center font-bold">{s.rate}%</td><td className="px-2 py-2 text-right">{s.ryokan.occupied}日</td><td className="px-2 py-2 text-right">{fmt(s.ryokan.netRevenue)}円</td><td className="px-2 py-2 text-right">{fmt(s.ryokan.variableCost)}円</td>
              <td className={`px-2 py-2 text-right font-bold ${s.ryokan.profit>=0?"text-emerald-600":"text-red-500"}`}>{fmt(s.ryokan.profit)}円</td><td className="px-2 py-2 text-right">{fmt(s.ryokan.monthlyProfit)}円</td><td className="px-2 py-2 text-right text-gray-500">{s.ryokan.payback?fmtMonth(s.ryokan.payback*12):"—"}</td>
            </tr>)}</tbody>
          </table></div>
        </div>
        </>)}

        <div className="bg-gray-50 rounded-xl p-4 mb-5 text-xs text-gray-500 space-y-1">
          <p className="font-semibold text-gray-600">計算前提</p>
          <p>売上 = 稼働日数 x 宿泊単価 - OTA手数料（{prop.commissionRate}%）</p>
          <p>変動費 = ターンオーバー回数 x（清掃費+リネン+消耗品）{prop.guestCleaningFee>0?" - ゲスト清掃費収入":""}</p>
          <p>年間利益 = 売上 - 変動費 - 年間固定費（{fmt(R.aFix)}円）</p>
          {prop.guestCleaningFee>0 && <p>ゲスト清掃費収入 = ターンオーバー回数 x {fmt(prop.guestCleaningFee)}円 x (1 - {prop.commissionRate}%)</p>}
        </div>
        <div className="flex justify-between">
          <button onClick={()=>setTab(0)} className="px-5 py-2 bg-gray-100 text-gray-600 rounded-lg text-xs font-semibold hover:bg-gray-200 transition">物件情報に戻る</button>
          <button onClick={()=>setTab(2)} className="px-5 py-2 bg-blue-500 text-white rounded-lg text-xs font-semibold hover:bg-blue-600 transition shadow-sm">法規制の詳細</button>
        </div>
      </div>)}

      {/* ============= Tab 3: 法規制チェック ============= */}
      {tab===2 && (<div>
        <div className="mb-5 p-4 bg-violet-50 rounded-xl border border-violet-200">
          <div className="flex flex-wrap items-center gap-2 mb-1">
            <p className="text-xs font-semibold text-violet-700">現在の設定:</p>
            <Tag color="purple">{LR.zone?.label||"未選択"}</Tag><Tag color="purple">{LR.muni?.label}</Tag><Tag color="gray">{legal.buildingType==="mansion"?"マンション":"一戸建て"}</Tag>
          </div>
          {auto_.zoneSugg&&<p className="text-xs text-violet-600">住所から自動検出（{auto_.zoneSugg.method==="keyword"?`キーワード: ${auto_.zoneSugg.keyword}`:"自治体のデフォルト"}）</p>}
          <button onClick={()=>setShowOverride(!showOverride)} className="mt-2 text-xs text-violet-600 underline decoration-dotted">{showOverride?"閉じる":"手動で変更する"}</button>
          {showOverride&&<div className="mt-3 grid grid-cols-1 md:grid-cols-3 gap-4 p-3 bg-white rounded-lg">
            <Field label="用途地域" value={legal.zone} onChange={v=>upL("zone",v)} options={ZONES.map(z=>({value:z.id,label:z.label}))} />
            <Field label="自治体" value={legal.municipality} onChange={v=>upL("municipality",v)} options={MUNICIPALITIES.map(m=>({value:m.id,label:m.label}))} />
            <Field label="建物種別" value={legal.buildingType} onChange={v=>upL("buildingType",v)} options={[{value:"mansion",label:"マンション"},{value:"house",label:"一戸建て"}]} />
          </div>}
        </div>

        <Card title="民泊新法（住宅宿泊事業法）" tag={<Tag color={LR.zone?.minpaku===true?"green":LR.zone?.minpaku===false?"red":"gray"}>{LR.zone?.minpaku===true?"取得可能性あり":LR.zone?.minpaku===false?"不可":"要確認"}</Tag>}>
          <div className="space-y-3">
            <div className="p-3 bg-blue-50 rounded-xl text-xs text-blue-800 space-y-1">
              <p className="font-semibold">基本ルール</p>
              <p>・年間営業上限: {R.mDays}日（自治体条例反映済み）</p><p>・届出制（許可不要で比較的簡単）</p><p>・住宅要件を満たす必要あり</p><p>・管理業者の委託または家主居住型が必要</p>
            </div>
            {LR.muni?.restriction&&<div className="p-3 bg-amber-50 rounded-xl border border-amber-200 text-xs"><p className="font-semibold text-amber-700">{LR.muni.label}の条例</p><p className="text-amber-700 mt-1">{LR.muni.restriction}</p>{LR.isRes&&LR.muni.residentialDays&&<p className="text-amber-800 font-semibold mt-1">住居専用地域での営業可能日数: 年間{LR.muni.residentialDays}日</p>}</div>}
            {LR.muni?.tokku&&<div className="p-3 bg-blue-50 rounded-xl border border-blue-200 text-xs"><p className="font-semibold text-blue-700">国家戦略特区</p><p className="text-blue-700 mt-1">{LR.muni.tokkuNote}</p></div>}
            {legal.buildingType==="mansion"&&<div className="p-3 bg-orange-50 rounded-xl border border-orange-200 text-xs text-orange-700"><p className="font-semibold">マンションでの注意点</p><p className="mt-1">・管理規約で民泊禁止がないか確認必要</p><p>・管理組合の承認が必要な場合あり</p><p>・近隣住民とのトラブルリスクに注意</p></div>}
          </div>
        </Card>

        <Card title="旅館業法（簡易宿所）" tag={<Tag color={LR.zone?.ryokan===true?"green":LR.zone?.ryokan===false?"red":"gray"}>{LR.zone?.ryokan===true?"取得可能性あり":LR.zone?.ryokan===false?"不可":"要確認"}</Tag>} accent="green">
          <div className="space-y-3">
            <div className="p-3 bg-emerald-50 rounded-xl text-xs text-emerald-800 space-y-1">
              <p className="font-semibold">基本ルール</p>
              <p>・年間365日営業可能</p><p>・許可制（保健所への申請が必要）</p><p>・用途地域の制限あり（住居専用地域は原則不可）</p><p>・消防設備の設置が必要</p><p>・フロント設置義務あり（条件により免除可能）</p><p>・客室面積: 33㎡以上（10人未満なら1人3.3㎡以上）</p>
            </div>
            {LR.zone?.note&&<div className="p-3 bg-gray-50 rounded-xl text-xs text-gray-600"><p className="font-semibold">用途地域の注記</p><p className="mt-1">{LR.zone.note}</p></div>}
            {LR.zone?.ryokan===true&&<div className="p-3 bg-amber-50 rounded-xl border border-amber-200 text-xs text-amber-700 space-y-1"><p className="font-semibold">取得手続き</p><p>・用途地域の適合確認（事前相談推奨）</p><p>・消防設備の設置・点検</p><p>・100㎡超は用途変更の建築確認申請</p><p>・取得期間の目安: 1〜3ヶ月</p></div>}
          </div>
        </Card>

        <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-5 mb-5">
          <h3 className="text-sm font-bold text-gray-700 mb-3">比較表</h3>
          <div className="overflow-x-auto"><table className="w-full text-xs">
            <thead><tr className="bg-slate-50"><th className="px-3 py-2 text-left font-semibold text-gray-500">項目</th><th className="px-3 py-2 text-center font-semibold text-blue-600">民泊新法</th><th className="px-3 py-2 text-center font-semibold text-emerald-600">旅館業法</th></tr></thead>
            <tbody className="text-gray-700">
              {[["営業日数",`年間${R.mDays}日まで`,"年間365日"],["許認可","届出制（簡単）","許可制（審査あり）"],["取得期間","約2〜4週間","約1〜3ヶ月"],["費用目安","数万円","数十万円〜"],["消防設備","基本的なもの","自動火災報知+誘導灯"],["用途地域","ほぼ制限なし","住居専用は不可"],["収益性","日数上限で制約","高い（通年営業）"],
                ["この物件",LR.zone?.minpaku===true?"取得可能性あり":LR.zone?.minpaku===false?"不可":"要確認",LR.zone?.ryokan===true?"取得可能性あり":LR.zone?.ryokan===false?"不可":"要確認"],
              ].map(([item,m,r],i)=><tr key={i} className="border-t border-gray-50"><td className="px-3 py-2 font-semibold text-gray-600">{item}</td>
                <td className={`px-3 py-2 text-center ${i===7?(LR.zone?.minpaku===true?"text-blue-600 font-bold":LR.zone?.minpaku===false?"text-red-500 font-bold":""):""}`}>{m}</td>
                <td className={`px-3 py-2 text-center ${i===7?(LR.zone?.ryokan===true?"text-emerald-600 font-bold":LR.zone?.ryokan===false?"text-red-500 font-bold":""):""}`}>{r}</td>
              </tr>)}
            </tbody>
          </table></div>
        </div>

        <div className="p-4 bg-red-50 rounded-xl border border-red-200 text-xs text-red-700 space-y-1 mb-5">
          <p className="font-semibold">重要な注意事項</p>
          <p>・本シミュレーションは概算です。投資判断は自己責任で</p><p>・法規制は必ず管轄の保健所・自治体にご確認ください</p><p>・条例は随時改正されることがあります</p><p>・マンションの管理規約の確認が最重要</p><p>・専門家（行政書士等）への相談を推奨</p>
        </div>
        <div className="flex justify-between">
          <button onClick={()=>setTab(1)} className="px-5 py-2 bg-gray-100 text-gray-600 rounded-lg text-xs font-semibold hover:bg-gray-200 transition">収益シミュレーションに戻る</button>
          <button onClick={()=>setTab(0)} className="px-5 py-2 bg-blue-500 text-white rounded-lg text-xs font-semibold hover:bg-blue-600 transition shadow-sm">物件情報を修正</button>
        </div>
      </div>)}

      </div>
      <div className="max-w-4xl mx-auto px-4 py-6 text-center"><p className="text-xs text-gray-400">※ 本シミュレーションは概算です。実際の収益は季節変動・需要・競合状況等により異なります。</p></div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<MinpakuSimulator />);
</script>
</body>
</html>
